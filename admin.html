<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Lady of Fatima Shrine - Admin Dashboard</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 1200px; margin: auto; background-color: #f4f4f4; }
        h1, h2 { text-align: center; color: #333; }
        .dashboard-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-bar input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .search-bar button { padding: 8px 15px; border: none; background-color: #007BFF; color: white; border-radius: 4px; cursor: pointer; }
        .search-bar button:hover { background-color: #0056b3; }
        
        #records-container { margin-top: 20px; }
        .record-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px; background-color: #f9f9f9; cursor: pointer; }
        .record-card:hover { background-color: #e9e9e9; }
        .record-card h3 { margin-top: 0; }
        .record-card p { margin: 5px 0; }

        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        
        .modal-buttons { text-align: right; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; margin-left: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-edit { background-color: #ffc107; color: black; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-print { background-color: #28a745; color: white; }

        .edit-form-container { display: none; }
        .edit-form-container form { margin-top: 20px; }
        
        .counts-section { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; }
        .count-card { background: #e2eafc; padding: 15px; border-radius: 8px; text-align: center; min-width: 150px; margin: 10px; }
        .count-card h3 { margin: 0; color: #333; font-size: 24px; }
        .count-card p { margin: 5px 0 0; color: #666; }

        @media print {
            body * { visibility: hidden; }
            #record-details, #record-details * { visibility: visible; }
            #record-details { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <h1>Our Lady of Fatima Shrine - Admin Dashboard</h1>
    <div class="dashboard-section">
        <h2>üìä Quick Counts</h2>
        <div id="counts-container" class="counts-section">
            </div>
        <button onclick="fetchCounts()">Refresh Counts</button>
    </div>

    <div class="dashboard-section">
        <h2>üîç Search & Records</h2>
        <div class="search-bar">
            <input type="text" id="search-query" placeholder="Search by name, block, or address...">
            <button onclick="searchRecords()">Search</button>
            <button onclick="fetchRecords()">Show All Records</button>
        </div>
        <div id="records-container">
            </div>
    </div>

    <div id="record-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div id="record-details">
                </div>
            <div id="edit-form-container" class="edit-form-container">
                <form id="edit-record-form" onsubmit="saveChanges(event)">
                    <h3>Edit Record</h3>
                    <div id="edit-fields-container"></div>
                    <button type="submit">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfQa7_m_0Wq7I7lEW8We8L1pGMLyDqBDDK3ehSqp0ufS2yLVsQjls47jpEXmHtuuJ0/exec';
        let currentRecord = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetchRecords();
            fetchCounts();
        });

        async function fetchCounts() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getCounts`);
                const counts = await response.json();
                displayCounts(counts);
            } catch (error) {
                console.error('Error fetching counts:', error);
            }
        }

        function displayCounts(counts) {
            const container = document.getElementById('counts-container');
            container.innerHTML = `
                <div class="count-card"><h3>${counts.totalHouseholds}</h3><p>Households</p></div>
                <div class="count-card"><h3>${counts.totalMembers}</h3><p>Members</p></div>
                <div class="count-card"><h3>${counts.totalChildren}</h3><p>Children</p></div>
            `;
        }

        async function fetchRecords() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getRecords`);
                const records = await response.json();
                displayRecords(records);
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }
        
        async function searchRecords() {
            const query = document.getElementById('search-query').value;
            if (!query) {
                fetchRecords();
                return;
            }
            try {
                const response = await fetch(`${SCRIPT_URL}?action=search&query=${encodeURIComponent(query)}`);
                const records = await response.json();
                displayRecords(records);
            } catch (error) {
                console.error('Error searching records:', error);
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('records-container');
            container.innerHTML = '';
            if (records.length === 0) {
                container.innerHTML = '<p>No records found.</p>';
                return;
            }
            records.forEach(record => {
                const recordCard = document.createElement('div');
                recordCard.className = 'record-card';
                recordCard.innerHTML = `
                    <h3>Household: ${record.blockName} - ${record.residentialAddress}</h3>
                    <p>Members: ${record.members.length}, Children: ${record.children.length}</p>
                `;
                recordCard.onclick = () => showRecordDetails(record);
                container.appendChild(recordCard);
            });
        }
        
        function showRecordDetails(record) {
            currentRecord = record;
            const detailsContainer = document.getElementById('record-details');
            detailsContainer.innerHTML = formatRecordDetails(record);
            document.getElementById('edit-form-container').style.display = 'none';
            document.getElementById('record-modal').style.display = 'block';
        }

        function formatRecordDetails(record) {
            let html = `
                <h2>Record Details</h2>
                <div class="modal-buttons">
                    <button class="btn-edit" onclick="showEditForm()">‚úèÔ∏è Edit</button>
                    <button class="btn-delete" onclick="deleteRecord('${record.householdID}')">üóëÔ∏è Delete</button>
                    <button class="btn-print" onclick="printRecord()">üñ®Ô∏è Print</button>
                </div>
                <h3>Household Information</h3>
                <p><strong>Block:</strong> ${record.blockName}</p>
                <p><strong>Address:</strong> ${record.residentialAddress}</p>
                <p><strong>Contact No:</strong> ${record.contactNo}</p>
                <p><strong>Household ID:</strong> ${record.householdID}</p>
                <hr>
                <h3>Members</h3>
            `;

            record.members.forEach(member => {
                html += `
                    <div class="member-details">
                        <h4>${member.firstName} ${member.lastName}</h4>
                        <p><strong>DOB:</strong> ${member.dateOfBirth}</p>
                        <p><strong>Catholic:</strong> ${member.isCatholic}</p>
                        <p><strong>Occupation:</strong> ${member.occupation}</p>
                        <p><strong>Baptised:</strong> ${member.isBaptised} ${member.isBaptised === 'Yes' ? `(Date: ${member.dateOfBaptism})` : ''}</p>
                        <p><strong>1st Communion:</strong> ${member.isFirstCommunion} ${member.isFirstCommunion === 'Yes' ? `(Date: ${member.dateFirstCommunion})` : ''}</p>
                        <p><strong>Confirmed:</strong> ${member.isConfirmation} ${member.isConfirmation === 'Yes' ? `(Date: ${member.dateOfConfirmation})` : ''}</p>
                        <p><strong>Marital Status:</strong> ${member.maritalStatus} ${member.maritalStatus === 'Married' ? `(Civil Date: ${member.civilCourtMarriageDate}, Church Date: ${member.churchMarriageDate})` : ''}</p>
                        <p><strong>Divorced:</strong> ${member.isDivorced}</p>
                        <p><strong>Dikabelo:</strong> ${member.isDikabelo} ${member.isDikabelo === 'Yes' ? `(Date: ${member.dateLastDikabelo})` : ''}</p>
                    </div>
                `;
            });
            
            html += `<hr><h3>Children</h3>`;
            record.children.forEach(child => {
                html += `
                    <div class="child-details">
                        <h4>${child.firstName} ${child.lastName}</h4>
                        <p><strong>DOB:</strong> ${child.dateOfBirth} (Age: ${child.age})</p>
                        <p><strong>Catholic:</strong> ${child.isCatholic}</p>
                        <p><strong>Baptised:</strong> ${child.isBaptised} ${child.isBaptised === 'Yes' ? `(Date: ${child.dateOfBaptism})` : ''}</p>
                        <p><strong>1st Communion:</strong> ${child.isFirstCommunion} ${child.isFirstCommunion === 'Yes' ? `(Date: ${child.dateFirstCommunion})` : ''}</p>
                        <p><strong>Confirmed:</strong> ${child.isConfirmation} ${child.isConfirmation === 'Yes' ? `(Date: ${child.dateOfConfirmation})` : ''}</p>
                    </div>
                `;
            });

            return html;
        }

        function closeModal() {
            document.getElementById('record-modal').style.display = 'none';
        }
        
        function showEditForm() {
            // This is a simplified example. For a full-featured edit form,
            // you'd need to dynamically generate all form fields here,
            // similar to index.html, pre-filling them with currentRecord data.
            alert("Edit functionality requires generating a full form from the record data. This is a placeholder.");
        }

        async function saveChanges(e) {
            e.preventDefault();
            alert("Save changes functionality is a placeholder. You'll need to implement the logic to gather all form data from the edit form and send it to the Apps Script 'updateRecord' function.");
        }

        async function deleteRecord(householdId) {
            if (!confirm('Are you sure you want to delete this record and all associated members and children?')) return;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteRecord', householdId })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Record deleted successfully!');
                    closeModal();
                    fetchRecords();
                    fetchCounts();
                } else {
                    alert('Deletion failed: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting record:', error);
            }
        }

        function printRecord() {
            const printContent = document.getElementById('record-details').innerHTML;
            const originalBody = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalBody;
            window.location.reload();
        }
    </script>
</body>
</html>
